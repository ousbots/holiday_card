<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merry Christmas!</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #161e29 0%, #1a1a2e 100%);
            font-family: sans-serif;
            font-size: 18px;
            color: white;
        }
        canvas {
            background-color: black;
            border: 3px solid black;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            outline-style: none;
        }
    </style>

    <script>
      // Workaround for browsers requiring user interaction before creating an audio context.
      // Intercepts and pauses the audio context and resumes it on user interaction.
      // NOTE: https://developer.chrome.com/blog/web-audio-autoplay#moving-forward
      (function () {
        // An array of all contexts to resume on the page
        const audioContextList = [];

        // An array of various user interaction events we should listen for
        const userInputEventNames = [
          'click',
          'contextmenu',
          'auxclick',
          'dblclick',
          'mousedown',
          'mouseup',
          'pointerup',
          'touchend',
          'keydown',
          'keyup',
        ];

        // A proxy object to intercept AudioContexts and
        // add them to the array for tracking and resuming later
        self.AudioContext = new Proxy(self.AudioContext, {
          construct(target, args) {
            const result = new target(...args);
            audioContextList.push(result);
            return result;
          },
        });

        // To resume all AudioContexts being tracked
        function resumeAllContexts(event) {
          let count = 0;

          audioContextList.forEach(context => {
            if (context.state !== 'running') {
              context.resume();
            } else {
              count++;
            }
          });

          // If all the AudioContexts have now resumed then we
          // unbind all the event listeners from the page to prevent
          // unnecessary resume attempts
          if (count == audioContextList.length) {
            userInputEventNames.forEach(eventName => {
              document.removeEventListener(eventName, resumeAllContexts);
            });
          }
        }

        // We bind the resume function for each user interaction
        // event on the page
        userInputEventNames.forEach(eventName => {
          document.addEventListener(eventName, resumeAllContexts);
        });
      })();
    </script>

</head>

<body>
    <div id="loading">Loading Scene...</div>
    <script type="module">
        import init from './wasm/holiday_card.js'

        const loading = document.getElementById('loading');
        init()
            .then(() => { loading.style.display = 'none'; })
            .catch((error) => {
                if (!error.message.startsWith("Using exceptions for control flow")) {
                    console.error("Failed to initialize:", error);
                    loading.textContent = "Failed to load. Please refresh.";
                }
            });
    </script>
</body>

</html>
